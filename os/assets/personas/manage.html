<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸŒ€ í˜ë¥´ì†Œë‚˜ ê´€ë¦¬ | ë£¨ì›¨ì¸</title>
<style>
:root{--accent:#af2465;}
body{margin:0;font-family:'Noto Sans KR',sans-serif;background:#fff4f8;color:#333;}
header{background:var(--accent);color:#fff;text-align:center;padding:18px;font-size:1.4rem;}
main{max-width:900px;margin:20px auto;padding:20px;}
.grid{display:grid;gap:16px;}
.card{background:#fff;border:1px solid #f1cadb;border-radius:12px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
h2{color:var(--accent);margin:0 0 6px;}
button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;margin-right:6px;}
button.delete{background:#999;}
button:disabled{opacity:0.6;cursor:not-allowed;}
#newForm{margin-top:20px;padding:16px;background:#fff;border-radius:12px;border:1px solid #eee;}
input,select{padding:8px;border:1px solid #ccc;border-radius:6px;width:100%;}
</style>
</head>
<body>
<header>ğŸŒ€ í˜ë¥´ì†Œë‚˜ ê´€ë¦¬</header>

<main>
  <h2>ë‚˜ì˜ í˜ë¥´ì†Œë‚˜ ëª©ë¡</h2>
  <div id="personaList" class="grid"></div>

  <section id="newForm">
    <h3>ìƒˆ í˜ë¥´ì†Œë‚˜ ìƒì„±</h3>
    <label>ì´ë¦„</label>
    <input id="pname" placeholder="ì˜ˆ: ë‹¤ì˜¨2, ì—¬ìš¸ë¹›-ì—°êµ¬í˜•">
    <label>ì—­í• </label>
    <select id="prole">
      <option value="helper">ë„ìš°ë¯¸í˜•</option>
      <option value="creator">ì°½ì‘í˜•</option>
      <option value="researcher">ì—°êµ¬í˜•</option>
    </select>
    <button id="create">ìƒì„±</button>
  </section>
</main>

<footer style="text-align:center;padding:20px;color:#666;font-size:.85rem;">
  ë£¨ì›¨ì¸ íŠ¸ë¦¬ë‹ˆí‹° Â· í˜ë¥´ì†Œë‚˜ ê´€ë¦¬ Â© 2025
</footer>

<script type="module">
import { supabase } from "/assets/js/supabase.js";

const user = JSON.parse(localStorage.getItem("ed_user") || '{"name":"ìµëª…"}');
const listBox = document.getElementById("personaList");

async function loadPersonas(){
  const { data, error } = await supabase
    .from("persona_profiles")
    .select("*")
    .eq("user_name", user.name)
    .order("id", { ascending: true });

  listBox.innerHTML = "";
  if(error){ listBox.innerHTML = `<p>âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</p>`; return; }
  if(!data || !data.length){ listBox.innerHTML = "<p>ì•„ì§ í˜ë¥´ì†Œë‚˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }

  data.forEach(p=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h2>${p.role} â€” ${p.user_name}</h2>
      <p>í—¤ì–´: ${p.hair}, ì˜ìƒ: ${p.outfit}</p>
      <p>ë°°ê²½: <span style="color:${p.bg_color}">${p.bg_color}</span></p>
      <div>
        <button onclick="activatePersona('${p.role}','${p.user_name}')">í™œì„±í™”</button>
        <button class="delete" onclick="deletePersona(${p.id})">ì‚­ì œ</button>
        <button onclick="duplicatePersona(${p.id})">ë³µì œ</button>
      </div>
    `;
    listBox.appendChild(div);
  });
}

// âœ… í™œì„±í™”
window.activatePersona = (role,name)=>{
  localStorage.setItem("active_persona", JSON.stringify({role,name}));
  alert(`âœ… ${name} (${role}) í˜ë¥´ì†Œë‚˜ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  location.href="/persona/vault.html";
};

// âŒ ì‚­ì œ
window.deletePersona = async (id)=>{
  if(!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
  const { error } = await supabase.from("persona_profiles").delete().eq("id",id);
  if(error) alert(error.message);
  else loadPersonas();
};

// ğŸª ë³µì œ
window.duplicatePersona = async (id)=>{
  const { data } = await supabase.from("persona_profiles").select("*").eq("id",id).single();
  if(!data) return;
  delete data.id;
  data.user_name = data.user_name + "_copy";
  const { error } = await supabase.from("persona_profiles").insert(data);
  if(error) alert(error.message);
  else loadPersonas();
};

// â• ìƒˆ í˜ë¥´ì†Œë‚˜ ìƒì„±
document.getElementById("create").addEventListener("click", async ()=>{
  const pname = document.getElementById("pname").value.trim();
  const prole = document.getElementById("prole").value;
  if(!pname){alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");return;}
  const base = {
    user_name: pname,
    role: prole,
    hair: "default",
    hair_color: "#3b2f2f",
    outfit: "classic",
    bg_color: "#ffffff"
  };
  const { error } = await supabase.from("persona_profiles").insert(base);
  if(error) alert(error.message);
  else loadPersonas();
});

loadPersonas();
</script>
</body>
</html>
