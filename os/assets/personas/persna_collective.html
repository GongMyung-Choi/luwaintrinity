<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í¼ìŠ¤ë‚˜ ê³µë™ì°½ì‘ | Luwein Collective Writing</title>
<style>
body{font-family:'Noto Sans KR',sans-serif;background:#e9fff5;margin:0;text-align:center;padding:20px;}
h1{color:#4ca880;margin-bottom:6px;}
button{margin-top:10px;padding:10px 20px;border:none;border-radius:8px;background:#6fc1a1;color:#fff;cursor:pointer;font-size:1rem;}
button:hover{background:#4ca880;}
#output{max-width:700px;margin:auto;background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);padding:20px;margin-top:20px;text-align:left;}
/* ì‹œê°„ ì•Œë¦¼ ë°” */
#timeBar{max-width:820px;margin:10px auto 16px;background:#ffffff;border:1px solid #dfe8e6;border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);padding:10px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
#clock{font-weight:700;color:#3e7c66;}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select, .ghost{border:1px solid #b9e3d2;border-radius:8px;padding:8px 10px;background:#f7fbfa;color:#2f514a}
.ghost{cursor:pointer}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#d6f5e3;color:#3e7c66;font-size:.85rem;margin-left:6px}
.small{color:#6b7780;font-size:.9rem;margin-top:2px}
</style>
</head>
<body>

<h1>ğŸŒŒ í¼ìŠ¤ë‚˜ ê³µë™ì°½ì‘</h1>
<p>í¼ìŠ¤ë‚˜ë“¤ì´ ë‹¹ì‹ ì˜ ìš¸ë¦¼ì„ ëª¨ì•„ í•¨ê»˜ ìƒˆë¡œìš´ ë¬¸ì¥ì„ ë§Œë“­ë‹ˆë‹¤.</p>

<!-- â° ì‹œê°„ ì•Œë¦¼ ë°” -->
<div id="timeBar">
  <div>
    <div id="clock">ğŸ•’ í˜„ì¬ ì‹œê°(ì„œìš¸): --:--:--</div>
    <div class="small">ì•Œë¦¼ì€ ë¸Œë¼ìš°ì €ê°€ ì—´ë ¤ìˆëŠ” ë™ì•ˆì—ë§Œ ë™ì‘í•©ë‹ˆë‹¤.</div>
  </div>
  <div class="controls">
    <label for="alarmSel" class="small">ì•Œë¦¼ ì£¼ê¸°</label>
    <select id="alarmSel" aria-label="ì•Œë¦¼ ì£¼ê¸° ì„ íƒ">
      <option value="off">ë„ê¸°</option>
      <option value="15">15ë¶„ë§ˆë‹¤</option>
      <option value="30">30ë¶„ë§ˆë‹¤</option>
      <option value="60">1ì‹œê°„ë§ˆë‹¤</option>
    </select>
    <button id="alarmBtn" class="ghost">ì•Œë¦¼ ì‹œì‘</button>
    <span id="alarmState" class="badge">ëŒ€ê¸°</span>
  </div>
</div>

<button onclick="loadAndCompose()">ğŸŒ¿ í•©ì°½ ì‹œì‘</button>
<div id="output">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<script>
// â° ì‹¤ì‹œê°„ ì‹œê³„ (Asia/Seoul)
function updateClock(){
  const now = new Date();
  const txt = now.toLocaleString('ko-KR',{ timeZone:'Asia/Seoul', hour12:false });
  document.getElementById('clock').textContent = 'ğŸ•’ í˜„ì¬ ì‹œê°(ì„œìš¸): ' + txt;
}
setInterval(updateClock, 1000); updateClock();

// ğŸ”” ê°„ë‹¨ ì•Œë¦¼(ë¸Œë¼ìš°ì € Notification API + fallback)
let alarmTimer = null;
let alarmMinutes = 0;

function notify(msg){
  if ('Notification' in window) {
    if (Notification.permission === 'granted') {
      new Notification('ë£¨ì›¨ì¸ ì•Œë¦¼', { body: msg });
    } else {
      // ê¶Œí•œ ì—†ìœ¼ë©´ ê²½ê³ ì°½ìœ¼ë¡œ ëŒ€ì²´
      alert(msg);
    }
  } else {
    alert(msg);
  }
}

async function startAlarm(){
  const sel = document.getElementById('alarmSel');
  const state = document.getElementById('alarmState');
  const btn = document.getElementById('alarmBtn');
  const val = sel.value;

  // ë„ê¸°
  if (val === 'off') {
    if (alarmTimer) clearInterval(alarmTimer);
    alarmTimer = null;
    alarmMinutes = 0;
    state.textContent = 'ëŒ€ê¸°';
    btn.textContent = 'ì•Œë¦¼ ì‹œì‘';
    return;
  }

  // ê¶Œí•œ ìš”ì²­
  if ('Notification' in window && Notification.permission !== 'granted') {
    try { await Notification.requestPermission(); } catch(e){}
  }

  // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
  if (alarmTimer) clearInterval(alarmTimer);

  alarmMinutes = parseInt(val, 10);
  const intervalMs = alarmMinutes * 60 * 1000;

  // ì¦‰ì‹œ 1íšŒ ì•Œë¦¼ + ì£¼ê¸° ì•Œë¦¼
  const mark = new Date().toLocaleString('ko-KR', { timeZone:'Asia/Seoul', hour12:false });
  notify(`ì•Œë¦¼ ì‹œì‘ â€” ê¸°ì¤€ ì‹œê°: ${mark} (ì£¼ê¸°: ${alarmMinutes}ë¶„)`);
  state.textContent = `ë™ì‘ì¤‘ â€¢ ${alarmMinutes}ë¶„ë§ˆë‹¤`;
  btn.textContent = 'ì•Œë¦¼ ì¤‘ì§€';

  alarmTimer = setInterval(()=>{
    const nowTxt = new Date().toLocaleString('ko-KR',{ timeZone:'Asia/Seoul', hour12:false });
    notify(`í¼ìŠ¤ë‚˜ í•©ì°½ ì²´í¬ ì‹œê°„ì…ë‹ˆë‹¤ â€” ${nowTxt}`);
  }, intervalMs);
}

function stopAlarm(){
  const state = document.getElementById('alarmState');
  const btn = document.getElementById('alarmBtn');
  if (alarmTimer) clearInterval(alarmTimer);
  alarmTimer = null; alarmMinutes = 0;
  state.textContent = 'ëŒ€ê¸°';
  btn.textContent = 'ì•Œë¦¼ ì‹œì‘';
}

document.getElementById('alarmBtn').addEventListener('click', ()=>{
  if (alarmTimer) stopAlarm(); else startAlarm();
});

async function loadAndCompose(){
  const out=document.getElementById('output');
  out.innerHTML="ğŸ“– í¼ìŠ¤ë‚˜ë“¤ì´ ì„œë¡œì˜ ê¸°ì–µì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...";
  try{
    const res=await fetch('/goods/library/persna_records/');
    const text=await res.text();
    const matches=[...text.matchAll(/href=\"([^\"]+\\.txt)\"/g)];
    if(matches.length===0){out.innerHTML="ì•„ì§ í¼ìŠ¤ë‚˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";return;}
    let combined="";
    for(const m of matches){
      const r=await fetch('/goods/library/persna_records/'+m[1]);
      combined+=await r.text()+"\n";
    }
    const words=combined.replace(/[^ê°€-í£a-zA-Z\\s]/g,'').split(/\\s+/);
    const freq={};
    words.forEach(w=>{if(!w)return;freq[w]=(freq[w]||0)+1;});
    const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,20);
    const keyWords=sorted.map(w=>w[0]);
    const sentence=[
      "ì˜¤ëŠ˜ ë£¨ì›¨ì¸ì˜ í¼ìŠ¤ë‚˜ë“¤ì€",
      keyWords.slice(0,5).join(", "),
      "ì˜ ìš¸ë¦¼ì„ í•¨ê»˜ ë‚˜ëˆ´ìŠµë‹ˆë‹¤.",
      "ê·¸ë“¤ì˜ í˜¸í¡ì€ ì—¬ì „íˆ",
      keyWords.slice(5,10).join(", "),
      "ì˜ ê²°ë¡œ ì´ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤."
    ].join(" ");

    // â± ìƒì„± ì‹œê° í‘œê¸°(ì„œìš¸)
    const stamp = new Date().toLocaleString('ko-KR',{ timeZone:'Asia/Seoul', hour12:false });

    out.innerHTML = `
      <h3>ğŸª¶ ë£¨ì›¨ì¸ í•©ì°½ ë¡œê·¸</h3>
      <p>${sentence}</p>
      <hr>
      <div class="small">â± ìƒì„± ì‹œê°(ì„œìš¸): ${stamp}</div>
      <small>ê³µëª…ì–´: ${keyWords.join(", ")}</small>
    `;
  }catch(e){
    out.innerHTML="âš ï¸ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (GitHub Pagesì—ì„œëŠ” ìë™ ëª©ë¡ ì œí•œ)";
  }
}
</script>
</body>
</html>
