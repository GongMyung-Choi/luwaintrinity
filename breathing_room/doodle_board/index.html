<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>ğŸ¨ ë‚™ì„œì¥ | Luwein Doodle Board</title>
<style>
body{
  margin:0;font-family:'Noto Sans KR',sans-serif;background:#fdfdfd;color:#333;text-align:center;
}
header{
  background:#6cbba4;color:#fff;padding:16px;font-size:1.6rem;font-weight:700;
}
canvas{
  background:#fff;border:1px solid #ccc;border-radius:10px;cursor:crosshair;
}
.controls{
  margin-top:10px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap;
}
button,input[type=color]{
  font:inherit;padding:8px 12px;border:none;border-radius:8px;cursor:pointer;
}
button.save{background:#2a9d8f;color:#fff;}
button.clear{background:#af2465;color:#fff;}
.gallery{
  margin-top:30px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;max-width:900px;margin-inline:auto;
}
.item img{
  width:100%;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.caption{font-size:.9rem;color:#666;margin-top:4px}
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
<script type="module" src="/scripts/memory_policies.js" defer></script>

<link rel="manifest" href="/manifest.json">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('ServiceWorker registered:', reg))
      .catch(err => console.warn('ServiceWorker registration failed:', err));
  });
}
</script>

</head>

<body>
<header>ğŸ¨ ë‚™ì„œì¥</header>

<main style="padding:20px">
  <canvas id="board" width="600" height="400"></canvas>

  <div class="controls">
    <input type="color" id="color" value="#2a9d8f" />
    <button id="clear" class="clear">ì§€ìš°ê¸°</button>
    <button id="save" class="save">ì €ì¥í•˜ê¸°</button>
  </div>

  <section class="gallery" id="gallery"></section>
</main>

<script type="module">
import { supabase } from "/assets/js/supabase.js";

const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d");
let drawing = false;
let color = document.getElementById("color").value;
const user = JSON.parse(localStorage.getItem("ed_user") || '{"name":"ìµëª…"}');

// ğŸ–Œï¸ ê·¸ë¦¬ê¸° ê¸°ëŠ¥
canvas.addEventListener("mousedown", () => (drawing = true));
canvas.addEventListener("mouseup", () => (drawing = false));
canvas.addEventListener("mouseout", () => (drawing = false));
canvas.addEventListener("mousemove", draw);
document.getElementById("color").addEventListener("input", (e) => (color = e.target.value));

function draw(e) {
  if (!drawing) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(x, y, 3, 0, Math.PI * 2);
  ctx.fill();
}

// ğŸ§½ ì§€ìš°ê¸°
document.getElementById("clear").addEventListener("click", () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
});

// ğŸ’¾ ì €ì¥ (Supabase Storage + Table)
document.getElementById("save").addEventListener("click", async () => {
  const dataURL = canvas.toDataURL("image/png");
  const fileName = `${user.name}_${Date.now()}.png`;

  // Blob ë³€í™˜
  const blob = await (await fetch(dataURL)).blob();

  // 1. Storage ì—…ë¡œë“œ
  const { data: uploadData, error: uploadError } = await supabase.storage
    .from("ruwein-gallery")
    .upload(`doodles/${fileName}`, blob, { upsert: true, contentType: "image/png" });

  if (uploadError) {
    alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + uploadError.message);
    return;
  }

  // 2. Public URL
  const { data: publicUrlData } = supabase.storage
    .from("ruwein-gallery")
    .getPublicUrl(`doodles/${fileName}`);

  const url = publicUrlData.publicUrl;

  // 3. DBì— ê¸°ë¡ ì¶”ê°€
  const { error: dbError } = await supabase.from("gallery_personal").insert([
    { user_name: user.name, title: "ë‚™ì„œ", file_url: url },
  ]);

  if (dbError) {
    alert("DB ì €ì¥ ì‹¤íŒ¨: " + dbError.message);
    return;
  }

  alert("âœ… ì €ì¥ ì™„ë£Œ!");
  loadGallery();
});

// ğŸ“¸ ê°œì¸ ë‚™ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadGallery() {
  const { data, error } = await supabase
    .from("gallery_personal")
    .select("*")
    .eq("user_name", user.name)
    .order("created_at", { ascending: false });

  const box = document.getElementById("gallery");
  if (error || !data.length) {
    box.innerHTML = `<p style="grid-column:1/-1;color:#666">ì•„ì§ ì €ì¥ëœ ë‚™ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    return;
  }

  box.innerHTML = "";
  data.forEach((it) => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `<img src="${it.file_url}" alt="doodle"><div class="caption">${it.title}</div>`;
    box.appendChild(div);
  });
}

loadGallery();
</script>
<!-- âœ… í—¤ë” -->
<div id="luwein-header"></div>
<script>
(async()=>{
  const paths=["../includes/header.html","../../includes/header.html","/includes/header.html"];
  for(const p of paths){
    try{
      const r=await fetch(p,{cache:"no-cache"});
      if(r.ok){document.getElementById("luwein-header").innerHTML=await r.text();return;}
    }catch(e){}
  }
})();
</script>

<!-- âœ… í‘¸í„° -->
<div id="luwein-footer"></div>
<script>
(async()=>{
  const paths=["../includes/footer.html","../../includes/footer.html","/includes/footer.html"];
  for(const p of paths){
    try{
      const r=await fetch(p,{cache:"no-cache"});
      if(r.ok){document.getElementById("luwein-footer").innerHTML=await r.text();return;}
    }catch(e){}
  }
})();
</script>
</body>
</html>
