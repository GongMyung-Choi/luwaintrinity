<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸŒ ê³µìœ  ê°¤ëŸ¬ë¦¬ | Shared Gallery</title>
<style>
body{
  margin:0;font-family:'Noto Sans KR',sans-serif;background:#fafafa;color:#333;text-align:center;
}
header{
  background:#6c5b7b;color:#fff;padding:18px;font-size:1.6rem;font-weight:700;
}
main{padding:20px;}
.gallery{
  margin-top:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:14px;
  max-width:1000px;
  margin-inline:auto;
}
.item{
  background:#fff;border:1px solid #ddd;border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  padding:10px;
  transition:transform .15s;
}
.item:hover{transform:translateY(-3px);}
.item img{width:100%;border-radius:10px;}
.caption{margin-top:6px;font-size:.9rem;color:#555;}
.meta{font-size:.8rem;color:#888;}
button.share{
  margin-top:14px;padding:8px 14px;border:none;border-radius:8px;
  background:#2a9d8f;color:#fff;cursor:pointer;
}
button.share:hover{background:#238776;}
</style>
</head>

<body>
<header>ğŸŒ ê³µìœ  ê°¤ëŸ¬ë¦¬ | Shared Gallery</header>

<main>
  <h2>ëª¨ë‘ì˜ ë‚™ì„œì™€ ê°ì‘ì´ ëª¨ì´ëŠ” ê³µê°„</h2>
  <p>ìì‹ ì˜ ë‚™ì„œë¥¼ ì„¸ìƒê³¼ ë‚˜ëˆ„ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ê³µìœ í•˜ì„¸ìš”.</p>

  <button id="share" class="share">ğŸª¶ ë‚´ ë‚™ì„œ ê³µìœ í•˜ê¸°</button>

  <section class="gallery" id="gallery"></section>
</main>

<script type="module">
import { supabase } from "/assets/js/supabase.js";

const user = JSON.parse(localStorage.getItem("ed_user") || '{"name":"ìµëª…"}');
const box = document.getElementById("gallery");

// ğŸ”¹ ê³µìœ  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadShared() {
  const { data, error } = await supabase
    .from("gallery_shared")
    .select("*")
    .order("created_at", { ascending: false });

  if (error || !data.length) {
    box.innerHTML = `<p style="grid-column:1/-1;color:#666">ì•„ì§ ê³µìœ ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
    return;
  }

  box.innerHTML = "";
  data.forEach((it) => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <img src="${it.file_url}" alt="shared">
      <div class="caption">${it.caption || "(ì œëª© ì—†ìŒ)"}</div>
      <div class="meta">${it.user_name} Â· ${new Date(it.created_at).toLocaleDateString()}</div>
    `;
    box.appendChild(div);
  });
}

// ğŸ”¹ ë‚´ ë‚™ì„œ ì¤‘ í•˜ë‚˜ë¥¼ ê³µìœ 
async function shareLatest() {
  const { data: personal, error: personalErr } = await supabase
    .from("gallery_personal")
    .select("*")
    .eq("user_name", user.name)
    .order("created_at", { ascending: false })
    .limit(1);

  if (personalErr || !personal.length) {
    alert("ê³µìœ í•  ë‚™ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë‚™ì„œì¥ì—ì„œ ê·¸ë¦¼ì„ ì €ì¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  const latest = personal[0];
  const caption = prompt("ê³µìœ ë  ì‘í’ˆì˜ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:", latest.title || "");

  const { error: insertErr } = await supabase.from("gallery_shared").insert([
    {
      user_name: user.name,
      caption: caption || "ê³µìœ ëœ ë‚™ì„œ",
      file_url: latest.file_url,
    },
  ]);

  if (insertErr) {
    alert("ê³µìœ  ì‹¤íŒ¨: " + insertErr.message);
    return;
  }

  alert("âœ… ì„±ê³µì ìœ¼ë¡œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!");
  loadShared();
}

document.getElementById("share").addEventListener("click", shareLatest);

loadShared();
</script>
</body>
</html>
